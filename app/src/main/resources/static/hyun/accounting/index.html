<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>회비관리</title>
<script src="/node_modules/jquery/dist/jquery.min.js"></script>
<script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/node_modules/handlebars/dist/handlebars.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
<link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.css">

<style>
/*내꺼 css*/
#body-content{
  padding-top: 10vh;
  /* height: 85vh; 너무 벌어짐  */
  height: 70vh;
  position: relative;
}
#selectCate{
  display: inline-block;
  width: 150px;
}
table > thead {
  text-align: center;
}
table > tbody > tr > td {
  text-align: center;
}
</style>
</head>

<body>

  
<!--공통헤더 제이쿼리-->
<script type="text/javascript">
  $(document).ready(function () {
      $('#header').load('/junho/mainHeader.html'); //헤더 인클루드
      $('#top').load('/ssang/groupBoard/none-search-top.html'); //상준님헤더
      $('#footer').load('/junho/mainfooter.html'); //푸터부분 인클루드
  });

  $.ajax({ //로그인 여부 확인 ajax START 비회원은 main으로 보낸다.
        url : "/member/getLoginUser",
        type : "POST",
        datatype : "json",
        success : function(result) {
          let loginUserNo = result.data.no;
          if (result.status == "fail") {
            window.alert("회원이 아닙니다.");
            window.location.replace("/junho/index.html");
          } else {
            $.ajax({ //회원 등급 조회 모임장이 아니라면 등록 버튼을 감춘다.
              url : "/joinmember/grouplistbymno",
              type : "POST",
              datatype : "json",
              data : {"member.no" : loginUserNo },
              success : function(result) {
                console.log(result.data);
                // if (result.data[0].memberGrade.gradeNo != 1) {
                //   $("#x-create-btn").hide();  
                // }//회원 등급 조회 if END 
              
                // else if () for문 돌려서 모임에 가입한 사람이 맞는지 확인 할 것
                // 모임 목록에서 타고 들어와야 들어온 모임명과 맞춰볼 수 있음
              
              }//회원 등급 조회 success END           
            })//회원 등급 조회 ajax END 
          }//로그인 확인 else END
        }//로그인 여부 확인 success END
  }); //로그인 여부 확인 ajax END
</script>

<!--공통 헤더-->
<div id="header"></div>
<!--모임 헤더-->
<div id="top"></div>

<div id="body-content"> <!--body content 시작-->
  <div class="inner">
    <div> <!--회비 종류 카테고리 시작-->
      <select name="selectCate" id="selectCate" class="form-select form-select-sm" aria-label=".form-select-sm example"> <!-- onchange="getOpNo()"-->
      </select>
    </div> <!--회비 종류 카테고리 끝-->
    
    <div id="content" class="table-responsive-lg">  <!--table div 시작-->
      <table id="x-board-table" class="table table-hover">
        <thead>
          <tr>
            <th width="50px">번호</th>
            <th width="100px">유형</th>
            <th width="100px">상태</th>
            <th width="600px">제목</th>
            <th width="100px">작성일</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="x-create-btn" type="button" style="float: right" class="btn btn-primary">등록</button>
    </div> <!--table div 끝-->

    <!--페이지 네이션 시작-->
    <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-center">
        <li class="page-item disabled">
          <a class="page-link">Previous</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
    <!--페이지 네이션 끝-->
  </div>
</div><!--body content 끝-->

<!--메인 풋터-->
<div id="footer"></div>

<!--카테고리 생성 핸들 바-->
<script id="option-template" type="text/x-handlebars-template">
{{#each this}}
<option id="selectOp" value="{{no}}">{{cateName}}</option>
{{/each}}
</script>
<!--카테고리 생성 핸들 바 END-->

<!--카테고리 불러오기-->
<script>
  let selectList = document.querySelector("#selectCate");
  var selectOption = document.querySelector("#option-template");
  var opGernerator = Handlebars.compile(selectOption.innerHTML);

  $.ajax({
    url : "/accounting/catelist",
    type : "POST",
    async : false,
    success: function(result) {
      if (result.status == "fail") {
        window.alert("서버 요청 오류!");
        console.log(result);
        return;
      } else {
        // console.log(result.data);
        selectList.innerHTML = opGernerator(result.data);
      }
    }
  });
</script>

<!--게시글 목록 생성 핸들바-->
<script id="tr-template" type="text/x-handlebars-template">
  {{#each this}}
  <tr>
    <td>{{no}}</td>
    <td>{{actCate}}</td>
    <td>
      <select id="selectedStatus" disabled>
        <option vlaue="{{statusno}}">{{status}}</option>
      </select> 
    </td>
    <td><a href="view.html?no={{no}}">{{title}}</a></td>
    <td>{{registDate}}</td>
  </tr>
  {{/each}}
</script>
<!--게시글 목록 생성 핸들바 END-->

<!--게시글 목록 생성 ajax-->
<script>
  let tbody = document.querySelector("#x-board-table tbody")
  // console.log(tbody);
  var trTemplate = document.querySelector("#tr-template");
  
  var htmlGenerator = Handlebars.compile(trTemplate.innerHTML);

  $.ajax({
    url : "/accounting/listbygroup", //!!!!!!!!!!!!!!!!!!!!나중에 수정 하기!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    type : "POST",
    async : false,
    dataType : "json",
    data : {"group.no" : 1}, //!!!!!!!!!!!!!!!!!!!!!!!!!!!임시로 그룹 번호 줌!!!!!!!!!!!!!
    success: function(result) {
      var arr = result.data;
      // console.log(arr);
      var ing = "진행";
      var end = "완료";
      // console.log(arr.actCate);
      var updateData = []
      $.each(arr, function(index, arr) {
        updateData.push({
          "actCate" : arr.actCate.cateName,
          no : arr.no,
          title : arr.title,
          registDate : arr.registDate,
          statusno : arr.status,
          status : arr.status == 0 ? ing : end
        })
      })
      // console.log(updateData);
      tbody.innerHTML = htmlGenerator(updateData);
      // console.log(htmlGenerator(updateData));

    }//success END
  }); //ajax 페이지 처음 로드

  //selectbox 옵션별 목록 불러오기
  $(document).on("change", "#selectCate", function() {
    let cate = $("#selectCate option:selected").val();
    if (cate == 1) {
      $.ajax({
        url : "/accounting/listbygroup",
        type : "POST",
        async : false,
        datatype : "json",
        data : {"group.no" : 1}, //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!임시 번호 줌!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        success: function(result) {
          var arr = result.data;
          var ing = "진행";
          var end = "완료";
          var updateData = []
          $.each(arr, function(index, arr) {
            updateData.push({
              "actCate" : arr.actCate.cateName,
              no : arr.no,
              title : arr.title,
              registDate : arr.registDate,
              statusno : arr.status,
              status : arr.status == 0 ? ing : end
              })
              // console.log(updateData);
          })  
            tbody.innerHTML = htmlGenerator(updateData);
        }
      }); //게시글 목록 생성 ajax
    } else {
      $.ajax({
          url: "/accounting/selectedcate",
          type: "POST",
          asyn: false,
          data: {"actCate.no": $("#selectCate option:selected").val()},
          success: function(result) {
            var arr = result.data;
            // console.log(arr);
            var ing = "진행";
            var end = "완료";
            var updateData = []
            $.each(arr, function(index, arr) {
              updateData.push({
                "actCate" : arr.actCate.cateName,
                no : arr.no,
                title : arr.title,
                registDate : arr.registDate,
                statusno : arr.status,
                status : arr.status == 0 ? ing : end
                })
            })  
              tbody.innerHTML = htmlGenerator(updateData);
          }//success END
        })//ajax END
    }
  })// selectbox change event END  

  //form.html
  document.querySelector("#x-create-btn").onclick = function(){
    location.href="form.html";
  };
</script>
</body>
</html>