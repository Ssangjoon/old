<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="/node_modules/jquery/dist/jquery.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.css">
  <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/node_modules/handlebars/dist/handlebars.min.js"></script>

  <title>회비 및 정산</title>

  
  <style>
    #form-content{ 
      padding-top: 10vh;
      height: 85vh;
      position: relative;
    }
    form {
      margin: 10px auto;
    }
    #x-add-btn, #x-cancel-btn {
      float: right;
      margin: 5px;
    }
    table > tbody > tr > td:first-child {
      text-align: right;
      column-span: 300px;
    }
    /*멤버 추가부분*/
    #x-deleteMemb-btn {
      margin: 10px auto;
    }
    .List-Container, .select-List-Container {
      margin:auto; /*가운데 정렬*/
      text-align:center;
    }
  </style>

</head>

<body>
    
 <!--공통헤더-->
  <div id="header"></div>
  <!--모임 헤더-->
  <div id="top"></div>

  <!--입력 폼 -->
<div id="form-content" class="table-responsive-lg">
  <div class="inner">
    <form name="accounting-form">
      <table id="formTable" class="table table-borderless">
        <tbody>
          <!-- <tr>
            <td width="150px">모임번호</td>
            <td><input id="x-gno" name="group.no" type="number" class="form-control"></td>
          </tr> -->
          <tr>
            <td>제목</td>
            <td><input id="x-title" name="title" type="text" class="form-control"></td>
          </tr>
          <tr>
            <td>유형</td>
            <td>
              <select id="x-selectCate" name="actCate.no" class="form-select form-select-sm" aria-label=".form-select-sm example">
                <option id="selectOp" value="">유형을 선택하세요</option>
                <option id="selectOp" value="2">회비</option>
                <option id="selectOp" value="3">모임비</option>
                <option id="selectOp" value="4">기타</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>진행상태</td>
            <td>
              <select id="x-status" name="status" class="form-select form-select-sm" aria-label=".form-select-sm example">
                <option id="statusOp" value="0">진행</option>
                <option id="statusOp" value="1">완료</option>
              </select>       
            </td>
          </tr>
          <tr>
            <td>금액</td>
            <td><input id="x-amount" name="amount" type="number" class="form-control" id="changeText"></td>
          </tr>
        </tbody>
      </table>

      <div>
        <button type="button" class="btn btn-primary" id="selectMemb">멤버 리스트</button>
        <button type="button" class="btn btn-primary" id="cleanMemb">멤버 초기화</button>
        <!-- <button type="button" class="btn btn-primary" id="Allmoney">금액 동일 적용</button> -->
      </div>

      <!--전체 멤버 추가부분-->
      <div class="List-Container">
        <div id="x-membList-container">
        </div>
        <button id="x-addMemb-btn" type="button" class="btn btn-primary">추가</button><br>
      </div>
      <!--전체 멤버 추가부분 END-->

      <!--멤버 선택 모달창-->
      <div class="modal fade" id="memberlist-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">입력할 멤버를 선택해 주세요</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="modal-member-list">
              </div>
            </div>
            <div class="modal-footer" style=" text-align: center;">
              <button type="button" class="btn btn-primary" id="allMemb">전체 적용</button>
              <button type="button" class="btn btn-primary" id="selectedOK">선택 적용</button>
            </div>
          </div>
        </div>
      </div>
      <!--멤버 선택 모달창-->
      
      <button id="x-add-btn" type="button" class="btn btn-primary">등록</button>
      <button id="x-cancel-btn" type="button" class="btn btn-primary">취소</button><br>
    </form>    
  </div>
</div>
<!--공통footer-->
<div id="footer"></div>




<script type="text/javascript">
$(document).ready(function() {
      $('#header').load('/junho/mainHeader.html'); //헤더 인클루드
      $('#top').load('/ssang/groupBoard/none-search-top.html'); //상준님헤더
      $('#footer').load('/junho/mainfooter.html'); //푸터부분 인클루드
      $(".List-Container").hide();
      $(".select-List-Container").hide();

      
  // $.ajax({ //로그인 여부 확인 ajax START 비회원은 main으로 보낸다.
  //       url : "/member/getLoginUser",
  //       type : "POST",
  //       datatype : "json",
  //       success : function(result) {
  //         let loginUserNo = result.data.no;
  //         if (result.status == "fail") {
  //           window.alert("회원이 아닙니다.");
  //           window.location.replace("/junho/index.html");
  //         } else {
  //           $.ajax({ //회원 등급 조회 모임장이 아니라면 등록 버튼을 감춘다.
  //             url : "/joinmember/grouplistbymno",
  //             type : "POST",
  //             datatype : "json",
  //             data : {"member.no" : loginUserNo },
  //             success : function(result) {
  //               console.log(result.data);
  //               if (result.data[0].memberGrade.gradeNo != 1) {
  //                 $("#x-create-btn").hide();  
  //               }//회원 등급 조회 if END 
              
  //               // else if () for문 돌려서 모임에 가입한 사람이 맞는지 확인 할 것
  //               // 모임 목록에서 타고 들어와야 들어온 모임명과 맞춰볼 수 있음
              
  //             }//회원 등급 조회 success END           
  //           })//회원 등급 조회 ajax END 
  //         }//로그인 확인 else END
  //       }//로그인 여부 확인 success END
  // }); //로그인 여부 확인 ajax END
});
</script>

<!--멤버 추가 Handlebars START-->
<script id="div-template" type="text/x-handlebars-template">
  {{#each this}}
  <div class="x-membList">
  이름 : <input id="listmembName" type="text" value="{{member.memberName}}">
        <input id="membno" value={{member.no}} type="hidden">
        <input id="gno" value={{group.no}} type="hidden">

  납부일 : <input type="date" id="paydt">
  <button id="x-deleteMemb-btn" type="button" class="btn btn-primary" onclick="deleteDiv(event)">삭제</button><br>
  </div>
  {{/each}}
</script>
<!--멤버 추가 Handlebars START-->

<!--모달 창 내 멤버 리스트-->
<script id="modal-memberlist-template" type="text/x-handlebars-template">
  {{#each this}}
  <div class="form-check">
  <input class="form-check-input" name="memberNo" type="checkbox" value="{{member.no}}" id="flexCheckDefault {{member.no}}">
    <label class="form-check-label" for="flexCheckDefault {{member.no}}">
      {{member.memberName}}
    </label>
  </div>
  {{/each}}
</script>
  

<script>
// let xGno = document.querySelector("#x-gno");
let xTitle = document.querySelector("#x-title");
let xAmount = document.querySelector("#x-amount");
let xMembList = document.querySelector(".x-membList");
let xMembListCon = document.querySelector("#x-membList-container");

//멤버 전체 불러오기
// let memberListAll = document.querySelector("#x-membList-container");
let divTemplate = document.querySelector("#div-template");
let divGenerator = Handlebars.compile(divTemplate.innerHTML);

//모달창 내 멤버 전체 불러오기
let modalMemberList = document.querySelector("#modal-member-list");
let checkboxTemplate = document.querySelector("#modal-memberlist-template");
let checkboxGenerator = Handlebars.compile(checkboxTemplate.innerHTML);

// console.log(document.querySelector("#memberlist-modal"));
//멤버 선택 버튼 클릭 -> 모달
$("#selectMemb").on("click", function() { //멤버리스트 버튼 클릭 EVENT START
  // console.log("클릭");
  $("#memberlist-modal").modal("show");
  // $("#modal-member-list").show();

  $.ajax({
    url : "/joinmember/grouplistbygno",
    type : "POST",
    data : {"group.no": gno}, 
    success: function(result) {
      // console.log(result.data);
      modalMemberList.innerHTML = checkboxGenerator(result.data); 

      $("#selectedOK").on("click", function(e) { //모달창에서 적용하기 버튼 click event START
        let choicedMember = []; 
        // console.log("클릭");
        let AllMember = result.data;
        console.log(AllMember);
        $("input:checkbox[name=memberNo]:checked").each(function() { //체크박스가 true인 속성 가져오기
          var checkedMember = $(this).val();
          choicedMember.push(AllMember[checkedMember -1]);
          // console.log("선택된 멤버" + choicedMember);

          $(".List-Container").show();
          $("#x-addMemb-btn").hide();
          xMembListCon.innerHTML = divGenerator(choicedMember);
          // $("#modal-member-list").hide(); //멤버리스트 초기화
          $("#memberlist-modal").modal("hide");
        })
      }) //모달창에서 적용하기 버튼 click event END

      //모달창 내 멤버 전체 버튼 클릭 EVENT START
      $("#allMemb").on("click", function() {
        $.ajax({
          url : "/joinmember/grouplistbygno",
          type : "POST",
          data : {"group.no": 1}, //!!!!!!!!!!!!!!!!!!!나중에 모임번호로 바꾸기!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          success: function(result) {
            console.log(result.data);
            $(".List-Container").show();
            $("#x-addMemb-btn").hide();
            xMembListCon.innerHTML = divGenerator(result.data); 
            $("#memberlist-modal").modal("hide");
          } //success END
        })//ajax END
      })//모달창 내 멤버 전체 버튼 클릭 EVENT END
    } //success END
  })//ajax END
}) //멤버리스트 버튼 클릭 EVENT START END



//멤버 개별 div의 삭제 이벤트
function deleteDiv(e) {
// if (xMembListCon.childElementCount > 1) {
        xMembListCon.removeChild(e.target.parentNode);
      // }
    };

//멤버 전체 div의 추가 이벤트
// document.querySelector("#x-addMemb-btn").onclick = function() {
//   let membList = xMembList.cloneNode(true);
//   membList.querySelector("#listAmount").value = "";
//   membList.querySelector("#listmembName").value = "";
//   xMembListCon.append(membList);
// };

//멤버 초기화 버튼
$("#cleanMemb").on("click", function() {
  console.log("클릭");
  // $(".List-Container").empty();
  $("#x-membList-container").empty();
});


//등록 버튼 클릭

document.querySelector("#x-add-btn").onclick = function() {
  let memberCount = xMembListCon.childElementCount;
  // if(
  //   $("#x-selectCate option:selected").val() == "" || 
  //    xTitle.value == "" || 
  //    xAmount.value == "" ||
  //    memberCount == 0) {
  //     window.alert("필수 입력 항목이 비어 있습니다.");
  //     return;
  // }

  let memberListAll = document.querySelectorAll(".x-membList");
  var qs = `group.no=${gno}&actCate.no=${$("#x-selectCate option:selected").val()}&title=${xTitle.value}&amount=${xAmount.value}&status=${$("#x-status option:selected").val()}`
  for (var memberDiv of memberListAll) {
    var xMembNo = memberDiv.querySelector("#membno");
    var xGno = memberDiv.querySelector("#gno");
    var xDate = memberDiv.querySelector("#paydt");
    qs += `&actStatus=${xMembNo.value}_${xGno.value}_${xDate.value}`;    
  }
  console.log(qs);
 
  fetch(`/accounting/add?${qs}`)
  .then(function(response) {
    return response.json();
  })
  .then(function(result) {
    console.log(result);
    // if (result.status == "success") {
    //   window.alert("등록되었습니다.");
    //   location.href = "index.html";
    // } else {
    //   window.alert("게시글 등록 실패!");
    //   console.log(result.data);
    // }
  })
} //add btn event END


//form.html로 이동
var arr = location.href.split("?");
  // console.log(arr);
  if (arr.length == 1) {
    alert("요청 형식이 올바르지 않습니다.")
    throw "URL 형식 오류!";
  }
  var qs = arr[1];
  // console.log("qs는?" + qs);
  var params = new URLSearchParams(qs);
  // console.log(params);
  var gno = params.get("gno");
  // console.log("gno는?" + gno);

//취소
document.querySelector("#x-cancel-btn").onclick = function() {
  // console.log("클릭함");
  window.location.href = "index.html?gno=" + gno;
};

</script>

</body>