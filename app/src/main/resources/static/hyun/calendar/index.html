<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="/node_modules/jquery/dist/jquery.min.js"></script>
  <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
  <!--full calendar node_modues-->
  <link href="/node_modules/fullcalendar/main.min.css" rel="stylesheet" />
  <script src="/node_modules/fullcalendar/main.min.js"></script>
  <script src="/node_modules/fullcalendar/locales/ko.js"></script> <!--한글설정-->
  <!--full calendar node_modues END-->
  <title>일정</title>

  <style>
  #calendar-container{
    padding-top: 2vh;
    height: 70vh;
    position: relative;
    margin-bottom: 30vh;
  }
  #calendar {
    max-width: 1100px;
    margin: 40px auto;
}
  .fc-header-toolbar > .fc-toolbar-chunk > .fc-addEventButton-button {
      border: 0px;
      background-color: rgb(17, 147, 218);
      margin-right: 13px;      
  }
  .fc-header-toolbar > .fc-toolbar-chunk > .fc-today-button {
      border: 0px;
      background-color: red;
  }
  .fc-header-toolbar > .fc-toolbar-chunk > .fc-button-group > .fc-prev-button{
    border: 0px;
    background-color: rgb(17, 147, 218);
  }
  .fc-header-toolbar > .fc-toolbar-chunk > .fc-button-group > .fc-next-button{
    border: 0px;
    background-color: rgb(17, 147, 218);
  }  
  </style>
</head>

<body class="menu3">
<script type="text/javascript">
$(document).ready(function () {
  $('#header').load('/junho/mainHeader.html'); 
  $('#top').load('/ssang/groupBoard/none-search-top.html');
  $('#footer').load('/junho/mainfooter.html'); 
});
</script>


<div id="header"></div>
<div id="top"></div>

<!--캘린더 API 자리-->
<div id="calendar-container">
<!-- <div class="inner"> -->
  <div id='calendar'></div>
<!-- </div> -->
</div>

<!--일정관리 추가 눌렀을 때 모달창-->
<div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
<from id="calendar-add">
  <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">일정을 입력하세요.</h5>
            </div>
            <div class="modal-body">
                    <div class="form-group">
                        <label for="taskId" class="col-form-label">일정 제목</label>
                        <input type="text" name="name" class="form-control" id="add-modal-title">
                        <label for="taskId" class="col-form-label">일정 내용</label>
                        <input type="text" name="content" class="form-control" id="add-modal-content">
                        <label for="taskId" class="col-form-label">시작 날짜</label>
                        <input type="date" name="startDt" class="form-control" id="add-modal-startDt">
                        <label for="taskId" class="col-form-label">종료 날짜</label>
                        <input type="date" name="endDt" class="form-control" id="add-modal-endDt">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="x-addCalendar">추가</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
  </from>
</div>

<!--상세보기 모달창-->
<div class="modal fade" id="view-Modal" tabindex="-1">
    <form name="calendar-update">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!--모임 title들어감-->
                <input type="text" name="name" id="view-modal-title" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div> <!--modal-header END-->
            <div class="modal-body">
                <div class="form-group">
                        <label for="taskId" class="col-form-label">약속 내용</label>                    
                        <input type="text" name="content" id="view-modal-content" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                        <label for="taskId" class="col-form-label">시작 날짜</label>
                        <input type="date" name="startDt" id="view-modal-startDt" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                        <label for="taskId" class="col-form-label">끝 날짜</label>
                        <input type="date" name="endDt" id="view-modal-endDt" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                        <label for="taskId" class="col-form-label">모임 장소 URL <button type="button" class="btn btn-primary" id="Gomidpoint-Btn">중간지점찾기</button></label>
                        <input type="url" name="resulturl" id="view-modal-resultURL" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                    </div><!--form-group END-->
                </div><!--modal-body END-->
                <div class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                    <button type="button" class="btn btn-primary" id="modal-UpdateBtn">변경</button>
                    <button type="button" class="btn btn-primary" id="modal-DeleteBtn">삭제</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div> <!--modal-footer END-->
            </div> <!--modal-content END-->
        </div> <!--modal-dialog END-->
    </form>
</div> <!--view-Modal END-->

<div id="footer"></div>

<script type="text/javascript">
var arr = location.href.split("?");
  if (arr.length == 1) {
    alert("요청 형식이 올바르지 않습니다.")
    throw "URL 형식 오류!";
  }
  var qs = arr[1];
  var params = new URLSearchParams(qs);
  var gno = params.get("gno");

//로그인 여부 확인
$.ajax({ //로그인 여부 확인 ajax START 비회원은 main으로 보낸다.
  url : "/member/getLoginUser",
  type : "POST",
  datatype : "json",
  success : function(result) {
    let loginUserNo = result.data.no;
    if (result.status == "fail") {
      window.alert("회원이 아닙니다.");
      window.location.replace("/junho/index.html");
    } else {
      $.ajax({ //회원 등급 조회 모임장이 아니라면 등록 버튼을 감춘다.
        url : "/joinmember/grouplistbymno",
        type : "POST",
        datatype : "json",
        data : {"member.no" : loginUserNo },
        success : function(result) {
          MemberInfo = result.data;
          var memberAuthority; //멤버등급번호
          var currentGroup = []; //현재 모임정보

          for (i=0; i < MemberInfo.length; i++) { //현재 있는 그룹의 정보 배열로 빼기
            if (gno == MemberInfo[i].group.no) {
              memberAuthority = MemberInfo[i].memberGrade.gradeNo
              currentGroup.push({
                group : MemberInfo[i].group,
                member : MemberInfo[i].member,
                memberGrade : MemberInfo[i].memberGrade,
              })
            }       
          }

          if (currentGroup.length == 0 || gno != currentGroup[0].group.no  ) {
            window.alert("가입된 소모임이 아닙니다");
            location.href="/junho/index.html";
          } else {
            console.log("가입한 소모임");
          }

          if (memberAuthority != 1) {
            $(".fc-addEventButton-button").hide();
            $("#Gomidpoint-Btn").hide();
            $("#modal-UpdateBtn").hide();
            $("#modal-DeleteBtn").hide();
          }//회원 등급 조회 if END    
        }//회원 등급 조회 success END           
      })//회원 등급 조회 ajax END 
    }//로그인 확인 else END
  }//로그인 여부 확인 success END
}); //로그인 여부 확인 ajax END  

document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
    height: 600, // calendar 높이 설정
    expandRows: true, // 화면에 맞게 높이 재설정
    handleWindowResize: true, //브라우저 창의 크기를 조정할 때 캘린더 크기를 자동으로 조정
    timeZone: 'local',
    initialView: 'dayGridMonth', //월만 보이게함
    editable: false, // false로 변경 시 draggable 작동 x 
    displayEventTime: false, // 시간 표시 x
    headerToolbar: {center: 'addEventButton'}, // headerToolbar에 버튼을 추가

    events: function(info, successCallback, failureCallback) { //캘린더 화면에 뿌리기
        $.ajax({
                url: '/calendar/listbygroup',
                type: 'POST',
                async : false, //비동기 off
                datatype : 'json',
                data : {"joinMemb.group.no" : gno},
                success: function(param) {
                    var events = [];
                    $.each(param.data, function(index, data){
                    events.push({
                        id : data.no,
                        title : data.name,
                        start : data.startDt,
                        end: data.endDt + 'T23:59:59'
                        });
                    }) //each END
                    successCallback(events);
                }// success END
            }) //캘린더 리스트 불러오는ajax END
    },//events ajax list function END
        
    eventClick: function(info) { //날짜를 클릭하면 나오는 이벤트
    var eventObj = info.event;
      console.log(eventObj);
      $("#Gomidpoint-Btn").on("click", function() {
          window.location.href=`/junho/midpoint/membermidpoint.html?gno=${gno}&cal_no=${eventObj.id}`;
      })
        $.ajax({
            url: '/calendar/get',
            type: 'POST',
            async : false, //비동기 off
            data: { no: eventObj.id },
            success: function(param) {
                console.log(param);
                    let data = param.data;
                console.log($("#view-Modal"));
                $("#view-Modal").modal("show"); //상세보기 모달창 나타냄
                //값 출력
                // console.log(data.joinMemb.group.no);
                $("#view-modal-title").val(data.name);
                $("#view-modal-content").val(data.content);
                $("#view-modal-gno").val(data.joinMemb.group.no);
                $("#view-modal-startDt").val(data.startDt);
                $("#view-modal-endDt").val(data.endDt);
                $("#view-modal-resultURL").val(data.resulturl);
                if ($("#view-modal-resultURL").val() != null){
                } else {
                    $("#view-modal-resultURL").val(" ");
                }

                $("#modal-DeleteBtn").on("click", function() { 
                    $.ajax({
                        url: '/calendar/delete',
                        type: 'POST',
                        data: { no: eventObj.id },
                            success: function(data) {
                                    // console.log(data.status);
                                    if(data.status == 'fail') {
                                        alert("삭제 권한이 없습니다.");
                                        window.location.href = "index.html?gno=" + gno;
                                    } else {
                                        alert('삭제되었습니다.');
                                        window.location.href = "index.html?gno=" + gno;
                                    }                                        
                                }
                            }) //delete요청 ajax END
                            // window.location.reload();
                        })// deletebtn function END
                
                //변경 버튼
                $("#modal-UpdateBtn").on("click", function() { //UpdateBtn function
                    //내용 입력 여부 확인
                    if($("#view-modal-content").val() == null || $("#view-modal-content").val() == ""){
                            alert("내용을 입력하세요.");
                        }else if($("#view-modal-startDt").val() == "" || $("#view-modal-endDt").val() ==""){
                            alert("날짜를 입력하세요.");
                        }else if(new Date($("#view-modal-endDt").val())- new Date($("#view-modal-startDt").val()) < 0){ // date 타입으로 변경 후 확인
                            alert("종료일이 시작일보다 먼저입니다.");
                        }else{ //정상 입력
                            var fd = new FormData(document.forms.namedItem("calendar-update"))
                            fd.append("no", eventObj.id);
                            fd.append("g_no", gno)
                            
                            fetch("/calendar/update", {
                                method: "POST",
                                body: new URLSearchParams(fd)
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(result) {
                                if (result.status == "success") {
                                    window.alert("수정되었습니다.")
                                    window.location.href = "index.html?gno=" + gno;
                                } else {
                                    window.alert("게시글 변경 실패");
                                    console.log(result.data);
                                    window.location.href = "index.html?gno=" + gno;
                                }
                            })
                        } // else 정상입력 END
                }) //UpdateBtn function END
            } //calendar/get success END
        }) //calendar/get END
    } //eventClick END                         

    ,customButtons: {
        addEventButton: { // 일정 추가 버튼 설정
            text : "일정 추가",  // 버튼 내용
            click : function(){ // 버튼 클릭 시 이벤트 추가
                $("#calendarModal").modal("show"); // modal 나타내기
                // console.log($("#calendarModal"));
                $("#x-addCalendar").on("click",function(){  // modal 추가 버튼 클릭 시
                    var startDt = $("#add-modal-startDt").val();
                    var endDt = $("#add-modal-endDt").val();
                    var content = $("#add-modal-content").val();
                    var xname = $("#add-modal-title").val();
                    // var xURL = $("#add-modal-URL").val();
                    
                    //내용 입력 여부 확인
                    if(content == null || content == ""){
                        alert("내용을 입력하세요.");
                    }else if(startDt == "" || endDt ==""){
                        alert("날짜를 입력하세요.");
                    }else if(new Date(endDt)- new Date(startDt) < 0){ // date 타입으로 변경 후 확인
                        alert("종료일이 시작일보다 먼저입니다.");
                    }else{ // 정상적인 입력 시
                        $.ajax ({
                                url: '/calendar/add',
                                type: 'POST',
                                data: {
                                    "joinMemb.group.no": gno,
                                    "name": $("#add-modal-title").val(),
                                    "content": content,
                                    "startDt": startDt,
                                    "endDt": endDt
                                }, //Data END
                                dataType: 'json',
                                    success: function(data) {
                                        console.log(data);
                                        if (data.status == "success") {
                                            alert("일정이 추가 되었습니다.");
                                            window.location.href = "index.html?gno=" + gno;
                                        } else {
                                            alert("일정 추가 실패");
                                            console.log(data);
                                            window.location.href = "index.html?gno=" + gno;
                                        }
                                    }, //success END
                                    error: function() {
                                        alert("에러발생");
                                    }// error END
                                }) //add ajax END                        
                    } //정상입력시 else문 END
                    // window.location.reload();
                }); // modal 추가 버튼 클릭 이벤트 END
            } // 버튼 클릭 시 이벤트 END
        },// addEventButton END
    }, //customButtons
    }); //var calendar End
    calendar.render(); // 달력 출력
  }); //document.addEventListener End
</script>



</body>
</html>