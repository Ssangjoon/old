<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bts.yomojomo.dao.MyPageDao">
  
  <resultMap type="MyPage" id="MyPageMap">
    <id column="memb_no" property="no"/>
    <result column="membername" property="name"/>
    <result column="pwd" property="pwd"/>
    <result column="email" property="email"/>
    <result column="tel" property="tel"/>
    <result column="post_no" property="postNo"/>
    <result column="roadname_addr" property="roadNameAddr"/>
    <result column="base_addr" property="baseAddr"/>
    <result column="addr" property="addr"/>
    
    <collection property="finalActiveLocal" ofType="FinalActiveLocal">
      <id column="memb_no" property="no"/>
      <result column="act_local_no" property="itrlocalno"/>
    </collection>
    
    <collection property="finalPurpose" ofType="FinalPurpose">
       <id column="pups_no" property="no"/>
       <result column="memb_no" property="membno"/>
    </collection>
    
    <collection property="activeLocal" ofType="ActiveLocal">
      <id column="act_local_no" property="no"/>
      <result column="name_si" property="nameSi"/>
      <result column="name_gu" property="nameGu"/>
    </collection>
    
    <collection property="purpose" ofType="Purpose">
       <id column="pups_no" property="no"/>
       <result column="name" property="purposeName"/>
    </collection>
  </resultMap>
  
  <select id="findAll" resultMap="MyPageMap">
   <!-- select * from gms_memb;  -->      
  </select>

  <select id="findByMemberNo" resultMap="MyPageMap">      
    select
      m.memb_no,
      m.membername,
      m.email,
      m.tel,
      m.post_no,
      m.roadname_addr,
      m.base_addr,
      m.addr,
      a.act_local_no,
      a.name_si,
      a.name_gu,
      p.pups_no,
      p.name
    from
      gms_memb m
      inner join gms_final_activelocal fa on m.memb_no = fa.memb_no
      inner join gms_activelocal a on fa.act_local_no = a.act_local_no
      inner join gms_final_purpose fp on m.memb_no = fp.memb_no
      inner join gms_purpose p on fp.pups_no = p.pups_no
    where
      m.memb_no=#{no}
  </select>
  
  <update id="update" parameterType="MyPage">
	  update gms_memb set
		  pwd=password(#{pwd}),
		  tel=#{tel},
		  post_no=#{postNo},
		  roadname_addr=#{roadNameAddr},
		  base_addr=#{baseAddr},
		  addr=#{addr}
		where
		  memb_no=#{no}
  </update>

	<delete id="deleteLocal" parameterType="MyPage">
    delete fa from
      gms_memb m
      inner join gms_final_activelocal fa on m.memb_no=fa.memb_no
    where
      m.memb_no=#{no}
  </delete>
  
  <delete id="deletePurpose" parameterType="MyPage">
  delete fp from
      gms_memb m
      inner join gms_final_purpose fp on m.memb_no=fp.memb_no
    where
      m.memb_no=#{no}
  </delete>
  
  <insert id="insertLocal" parameterType="MyPage">
  insert into gms_final_activelocal(memb_no, act_local_no) 
	  values
	  <foreach collection="locals" item="FinalActiveLocal" separator=",">
	     (#{no}, #{FinalActiveLocal.itrlocalno})
	  </foreach>
  </insert>
  
  <insert id="insertPurpose" parameterType="MyPage">
  insert into gms_final_purpose(memb_no, pups_no) 
	  values
	  <foreach collection="pups" item="FinalPurpose" separator=",">
	     (#{no}, #{FinalPurpose.no})
    </foreach>
  </insert>
  
        
	</mapper>